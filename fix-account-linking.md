# Fix Account Linking Between Alexa and Cognito

## 1. Verify Cognito App Client Settings

1. Go to AWS Console > Amazon Cognito > User Pools
2. Select your User Pool
3. Go to the "App integration" tab
4. Under "App clients and analytics", select your app client

5. Verify the following settings:
   
   **Allowed callback URLs**: Must include ALL relevant Alexa domains:
   ```
   https://pitangui.amazon.com/api/skill/link/*
   https://layla.amazon.com/api/skill/link/*
   https://alexa.amazon.co.jp/api/skill/link/*
   https://pitangui.amazon.com/api/skill/link/M3RPN48POS9B20
   https://layla.amazon.com/api/skill/link/M3RPN48POS9B20
   https://alexa.amazon.co.jp/api/skill/link/M3RPN48POS9B20
   ```
   
   **Allowed sign-out URLs**: These can be the same as callback URLs or you can leave them empty
   
   **OAuth grant types**: Make sure "Authorization code grant" is selected
   
   **OpenID Connect scopes**: Select "email", "openid" and "profile"

6. Click "Save changes"

## 2. Verify Cognito Domain Settings

1. While still in "App integration" tab, go to "Domain"
2. If you've already switched from "Managed login" to "Hosted UI", verify the domain settings
3. Check if the domain is active by visiting: `https://[your-domain].auth.[region].amazoncognito.com`
4. Try accessing the hosted UI directly with a test URL:
   ```
   https://[your-domain].auth.[region].amazoncognito.com/login?client_id=[app-client-id]&response_type=code&scope=email+openid+profile&redirect_uri=https://pitangui.amazon.com/api/skill/link/M3RPN48POS9B20
   ```

## 3. Verify Alexa Skill Account Linking Settings

1. Go to the Alexa Developer Console
2. Select your Xviper skill
3. Navigate to "Account Linking" in the left menu
4. Verify these settings:

   **Security Provider**: OAuth 2.0
   
   **Authorization URI**:
   ```
   https://[your-domain].auth.[region].amazoncognito.com/oauth2/authorize
   ```
   
   **Access Token URI**:
   ```
   https://[your-domain].auth.[region].amazoncognito.com/oauth2/token
   ```
   
   **Client ID**: Your Cognito App Client ID
   
   **Client Secret**: Your Cognito App Client Secret (if you created one; otherwise leave empty)
   
   **Client Authentication Scheme**: HTTP Basic (if you have a client secret) or Credentials in request body
   
   **Scope**: `openid profile email`
   
   **Redirect URLs**: This is generated by Alexa - copy these URLs to add to your Cognito app client allowed callback URLs
   
   **Domain List**: Make sure all Cognito domains are allowed
   ```
   amazoncognito.com
   [your-domain].auth.[region].amazoncognito.com
   ```

5. Click "Save" and then "Yes" to rebuild your skill

## 4. Add Missing Headers in Cognito

If you have access to AWS Lambda, create a small function to add CORS headers to Cognito:

1. Go to AWS Lambda Console
2. Create a new function
3. Add this code:

```javascript
// Create fix-cognito-cors.js
exports.handler = async (event) => {
    // Log the incoming event for debugging
    console.log('Event:', JSON.stringify(event));
    
    // Get the domain from the event
    const domain = event.headers.Host;
    
    // Create a response with CORS headers
    const response = {
        statusCode: 200,
        headers: {
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',
            'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: 'CORS headers added' })
    };
    
    // Return the response
    return response;
};
```

4. Connect this to API Gateway in front of your Cognito endpoints

## 5. Test Account Linking Directly

1. Open a browser and try this flow manually:
   - Go to: `https://[your-domain].auth.[region].amazoncognito.com/login?client_id=[app-client-id]&response_type=code&scope=email+openid+profile&redirect_uri=https://pitangui.amazon.com/api/skill/link/M3RPN48POS9B20`
   - Log in with your credentials
   - You should be redirected to Alexa with an authorization code

2. If this works in the browser but not in the Alexa app, the issue is likely related to:
   - User-Agent restrictions
   - CORS headers
   - Mobile app webview limitations

## 6. Switch to Direct Auth in Lambda (Fallback Plan)

If account linking continues to fail, you can bypass OAuth completely and use direct authentication in your Lambda function:

1. Use the previously created simple-lambda.js that authenticates directly with the Viper API
2. Deploy it using the deploy-simple.bat script
3. Update your Alexa skill to remove account linking

## 7. Contact AWS Support

If you've tried all the above and still have issues:
1. Open a support case with AWS about Cognito OAuth with Alexa
2. Provide the error logs from both your Lambda function and any Cognito logs

## Debugging Tips

1. Check CloudWatch Logs for both your Lambda function and Cognito
2. Try account linking from different devices (mobile app, web browser)
3. Check for any network restrictions between Alexa and AWS
4. Verify all URLs exactly match (no trailing slashes or extra spaces)